//
//  SecondViewController.m
//  B Scanner
//
//  Created by Calvin Fernando on 4/18/14.
//  Copyright (c) 2014 Calvin Fernando. All rights reserved.
//

#import "SecondViewController.h"
#import "AppDelegate.h"

@interface SecondViewController ()

@property (nonatomic, strong) AppDelegate *appDelegate;

-(void)sendMyMessage;
-(void)didReceiveDataWithNotification:(NSNotification *)notification;

@end

@implementation SecondViewController
@synthesize myNewString;

- (void)viewDidAppear:(BOOL)animated{
    [super viewDidAppear:YES];
    
    AppDelegate   *sharedData = (AppDelegate *)([[UIApplication sharedApplication]delegate]);
    myNewString =sharedData.sharedString;
    
    if (![myNewString isEqualToString:@""]) {
        [self sendMyMessage];
    }
    
    labell.text = myNewString;
    
    NSLog(@"hh awal %@",hh);
    
    NSUserDefaults *defaults = [NSUserDefaults standardUserDefaults];
    
    nihData = [defaults objectForKey:@"savedString50"];
    
    NSLog(@"nihData sblm if%@",nihData);
    NSLog(@"nihData length %lu",(unsigned long)[nihData length]);
    
    if ([nihData length] == 0) {
        nihData = @"CUP001-CUP002-CUP003-CUP004-CUP005-CUP006-CUP007-CUP008-CUP009-CUP010-CUP011-CUP012-CUP013-CUP014-CUP015-CUP016-CUP017-CUP018-CUP019-CUP020-CUP021-CUP022-CUP023-CUP024-CUP025-CUP026-CUP027-CUP028-CUP029-CUP030-CUP031-CUP032-CUP033-CUP034-CUP035-CUP036-CUP037-CUP038-CUP039-CUP040-CUP041-CUP042-CUP043-CUP044-CUP045-CUP046-CUP047-CUP048-CUP049-CUP050-CUP051-CUP052-CUP053-CUP054-CUP055-CUP056-CUP057-CUP058-CUP059-CUP060-CUP061-CUP062-CUP063-CUP064-CUP065-CUP066-CUP067-CUP068-CUP069-CUP070-CUP071-CUP072-CUP073-CUP074-CUP075-CUP076-CUP077-CUP078-CUP079-CUP080-CUP081-CUP082-CUP083-CUP084-CUP085-CUP086-CUP087-CUP088-CUP089-CUP090-CUP091-CUP092-CUP093-CUP094-CUP095-CUP096-CUP097-CUP098-CUP099-CUP100-CUP101-CUP102-CUP103-CUP104-CUP105-CUP106-CUP107-CUP108-CUP109-CUP110-CUP111-CUP112-CUP113-CUP114-CUP115-CUP116-CUP117-CUP118-CUP119-CUP120-CUP121-CUP122-CUP123-CUP124-CUP125-CUP126-CUP127-CUP128-CUP129-CUP130-CUP131-CUP132-CUP133-CUP134-CUP135-CUP136-CUP137-CUP138-CUP139-CUP140-CUP141-CUP142-CUP143-CUP144-CUP145-CUP146-CUP147-CUP148-CUP149-CUP150-CUP151-CUP152-CUP153-CUP154-CUP155-CUP156-CUP157-CUP158-CUP159-CUP160-CUP161-CUP162-CUP163-CUP164-CUP165-CUP166-CUP167-CUP168-CUP169-CUP170-CUP171-CUP172-CUP173-CUP174-CUP175-CUP176-CUP177-CUP178-CUP179-CUP180-CUP181-CUP182-CUP183-CUP184-CUP185-CUP186-CUP187-CUP188-CUP189-CUP190-CUP191-CUP192-CUP193-CUP194-CUP195-CUP196-CUP197-CUP198-CUP199-CUP200-CUP201-CUP202-CUP203-CUP204-CUP205-CUP206-CUP207-CUP208-CUP209-CUP210-CUP211-CUP212-CUP213-CUP214-CUP215-CUP216-CUP217-CUP218-CUP219-CUP220-CUP221-CUP222-CUP223-CUP224-CUP225-CUP226-CUP227-CUP228-CUP229-CUP230-CUP231-CUP232-CUP233-CUP234-CUP235-CUP236-CUP237-CUP238-CUP239-CUP240-CUP241-CUP242-CUP243-CUP244-CUP245-CUP246-CUP247-CUP248-CUP249-CUP250-CUP251-CUP252-CUP253-CUP254-CUP255-CUP256-CUP257-CUP258-CUP259-CUP260-CUP261-CUP262-CUP263-CUP264-CUP265-CUP266-CUP267-CUP268-CUP269-CUP270-CUP271-CUP272-CUP273-CUP274-CUP275-CUP276-CUP277-CUP278-CUP279-CUP280-CUP281-CUP282-CUP283-CUP284-CUP285-CUP286-CUP287-CUP288-CUP289-CUP290-CUP291-CUP292-CUP293-CUP294-CUP295-CUP296-CUP297-CUP298-CUP299-CUP300-CUP301-CUP302-CUP303-CUP304-CUP305-CUP306-CUP307-CUP308-CUP309-CUP310-CUP311-CUP312-CUP313-CUP314-CUP315-CUP316-CUP317-CUP318-CUP319-CUP320-CUP321-CUP322-CUP323-CUP324-CUP325-CUP326-CUP327-CUP328-CUP329-CUP330-CUP331-CUP332-CUP333-CUP334-CUP335-CUP336-CUP337-CUP338-CUP339-CUP340-CUP341-CUP342-CUP343-CUP344-CUP345-CUP346-CUP347-CUP348-CUP349-CUP350-CUP351-CUP352-CUP353-CUP354-CUP355-CUP356-CUP357-CUP358-CUP359-CUP360-CUP361-CUP362-CUP363-CUP364-CUP365-CUP366-CUP367-CUP368-CUP369-CUP370-CUP371-CUP372-CUP373-CUP374-CUP375-CUP376-CUP377-CUP378-CUP379-CUP380-CUP381-CUP382-CUP383-CUP384-CUP385-CUP386-CUP387-CUP388-CUP389-CUP390-CUP391-CUP392-CUP393-CUP394-CUP395-CUP396-CUP397-CUP398-CUP399-CUP400-CUP401-CUP402-CUP403-CUP404-CUP405-CUP406-CUP407-CUP408-CUP409-CUP410-CUP411-CUP412-CUP413-CUP414-CUP415-CUP416-CUP417-CUP418-CUP419-CUP420-CUP421-CUP422-CUP423-CUP424-CUP425-CUP426-CUP427-CUP428-CUP429-CUP430-CUP431-CUP432-CUP433-CUP434-CUP435-CUP436-CUP437-CUP438-CUP439-CUP440-CUP441-CUP442-CUP443-CUP444-CUP445-CUP446-CUP447-CUP448-CUP449-CUP450-CUP451-CUP452-CUP453-CUP454-CUP455-CUP456-CUP458-CUP457-CUP459-CUP460-CUP461-CUP462-CUP463-CUP464-CUP465-CUP466-CUP467-CUP468-CUP469-CUP470-CUP471-CUP472-CUP473-CUP474-CUP475-CUP476-CUP477-CUP478-CUP479-CUP480-CUP481-CUP482-CUP483-CUP484-CUP485-CUP486-CUP487-CUP488-CUP489-CUP490-CUP491-CUP492-CUP493-CUP494-CUP495-CUP496-CUP497-CUP498-CUP499-CUP500-CUP501-CUP502-CUP503-CUP504-CUP505-CUP506-CUP507-CUP508-CUP509-CUP510-CUP511-CUP512-CUP513-CUP514-CUP515-CUP516-CUP517-CUP518-CUP519-CUP520-CUP521-CUP522-CUP523-CUP524-CUP525-CUP526-CUP527-CUP528-CUP529-CUP530-CUP531-CUP532-CUP533-CUP534-CUP535-CUP537-CUP536-CUP538-CUP539-CUP540-CUP541-CUP542-CUP543-CUP544-CUP545-CUP546-CUP547-CUP548-CUP549-CUP550-CUP551-CUP552-CUP553-CUP554-CUP555-CUP556-CUP557-CUP558-CUP559-CUP560-CUP561-CUP562-CUP563-CUP564-CUP565-CUP566-CUP567-CUP568-CUP569-CUP570-CUP571-CUP572-CUP573-CUP574-CUP575-CUP576-CUP577-CUP578-CUP579-CUP580-CUP581-CUP582-CUP583-CUP584-CUP585-CUP586-CUP587-CUP588-CUP589-CUP590-CUP591-CUP592-CUP593-CUP594-CUP595-CUP596-CUP597-CUP598-CUP599-CUP600-CUP601-CUP602-CUP603-CUP604-CUP605-CUP606-CUP607-CUP608-CUP609-CUP610-CUP611-CUP612-CUP613-CUP614-CUP615-CUP616-CUP617-CUP618-CUP619-CUP620-CUP621-CUP622-CUP623-CUP624-CUP625-CUP626-CUP627-CUP628-CUP629-CUP630-CUP631-CUP632-CUP633-CUP634-CUP635-CUP636-CUP637-CUP638-CUP639-CUP640-CUP641-CUP642-CUP643-CUP644-CUP645-CUP646-CUP647-CUP648-CUP649-CUP650-CUP651-CUP652-CUP653-CUP654-CUP655-CUP656-CUP657-CUP658-CUP659-CUP660-CUP661-CUP662-CUP663-CUP664-CUP665-CUP666-CUP667-CUP668-CUP669-CUP670-CUP671-CUP672-CUP673-CUP674-CUP675-CUP676-CUP677-CUP678-CUP679-CUP680-CUP681-CUP682-CUP683-CUP684-CUP685-CUP686-CUP687-CUP688-CUP689-CUP690-CUP691-CUP692-CUP693-CUP694-CUP695-CUP696-CUP697-CUP698-CUP699-CUP700-CUP701-CUP702-CUP703-CUP704-CUP705-CUP706-CUP707-CUP708-CUP709-CUP710-CUP711-CUP712-CUP713-CUP714-CUP715-CUP716-CUP717-CUP718-CUP719-CUP720-CUP721-CUP722-CUP723-CUP724-CUP725-CUP726-CUP727-CUP728-CUP729-CUP730-CUP731-CUP732-CUP733-CUP734-CUP735-CUP736-CUP737-CUP738-CUP739-CUP740-CUP741-CUP742-CUP743-CUP744-CUP745-CUP746-CUP747-CUP748-CUP749-CUP750-CUP751-CUP752-CUP753-CUP754-CUP755-CUP756-CUP757-CUP758-CUP759-CUP760-CUP761-CUP762-CUP763-CUP764-CUP765-CUP766-CUP767-CUP768-CUP769-CUP770-CUP771-CUP772-CUP773-CUP774-CUP775-CUP776-CUP777-CUP778-CUP779-CUP780-CUP781-CUP782-CUP783-CUP784-CUP785-CUP786-CUP787-CUP788-CUP789-CUP790-CUP791-CUP792-CUP793-CUP794-CUP795-CUP796-CUP797-CUP798-CUP799-CUP800-CUP801-CUP802-CUP803-CUP804-CUP805-CUP806-CUP807-CUP808-CUP809-CUP810-CUP811-CUP812-CUP813-CUP814-CUP815-CUP816-CUP817-CUP818-CUP819-CUP820-CUP821-CUP822-CUP823-CUP824-CUP825-CUP826-CUP827-CUP828-CUP829-CUP830-CUP831-CUP832-CUP833-CUP834-CUP835-CUP836-CUP837-CUP838-CUP839-CUP840-CUP841-CUP842-CUP843-CUP844-CUP845-CUP846-CUP847-CUP848-CUP849-CUP850-CUP851-CUP852-CUP853-CUP854-CUP855-CUP856-CUP857-CUP858-CUP859-CUP860-CUP861-CUP862-CUP863-CUP864-CUP865-CUP866-CUP867-CUP868-CUP869-CUP870-CUP871-CUP872-CUP873-CUP874-CUP875-CUP876-CUP877-CUP878-CUP879-CUP880-CUP881-CUP882-CUP883-CUP884-CUP885-CUP886-CUP887-CUP888-CUP889-CUP890-CUP891-CUP892-CUP893-CUP894-CUP895-CUP896-CUP897-CUP898-CUP899-CUP900-CUP901-CUP902-CUP903-CUP904-CUP905-CUP906-CUP907-CUP908-CUP909-CUP910-CUP911-CUP912-CUP913-CUP914-CUP915-CUP916-CUP917-CUP918-CUP919-CUP920-CUP921-CUP922-CUP923-CUP924-CUP925-CUP926-CUP927-CUP928-CUP929-CUP930-CUP931-CUP932-CUP933-CUP934-CUP935-CUP936-CUP937-CUP938-CUP939-CUP940-CUP941-CUP942-CUP943-CUP944-CUP945-CUP946-CUP947-CUP948-CUP949-CUP950-CUP951-CUP952-CUP953-CUP954-CUP955-CUP956-CUP957-CUP958-CUP959-CUP960-CUP961-CUP962-CUP963-CUP964-CUP965-CUP966-CUP967-CUP968-CUP969-CUP970-CUP971-CUP972-CUP973-CUP974-CUP975-CUP976-CUP977-CUP978-CUP979-CUP980-CUP981-CUP982-CUP983-CUP984-CUP985-CUP986-CUP987-CUP988-CUP989-CUP990-CUP991-CUP992-CUP993-CUP994-CUP995-CUP996-CUP997-CUP998-CUP999-CUP1000-CUP1001-CUP1002-CUP1003-CUP1004-CUP1005-CUP1006-CUP1007-CUP1008-CUP1009-CUP1010-CUP1011-CUP1012-CUP1013-CUP1014-CUP1015-CUP1016-CUP1017-CUP1018-CUP1019-CUP1020-CUP1021-CUP1022-CUP1023-CUP1024-CUP1025-CUP1026-CUP1027-CUP1028-CUP1029-CUP1030-CUP1031-CUP1032-CUP1033-CUP1034-CUP1035-CUP1036-CUP1037-CUP1038-CUP1039-CUP1040-CUP1041-CUP1042-CUP1043-CUP1044-CUP1045-CUP1046-CUP1047-CUP1048-CUP1049-CUP1050-CUP1051-CUP1052-CUP1053-CUP1054-CUP1055-CUP1056-CUP1057-CUP1058-CUP1059-CUP1060-CUP1061-CUP1062-CUP1063-CUP1064-CUP1065-CUP1066-CUP1067-CUP1068-CUP1069-CUP1070-CUP1071-CUP1072-CUP1073-CUP1074-CUP1075-CUP1076-CUP1077-CUP1078-CUP1079-CUP1080-CUP1081-CUP1082-CUP1083-CUP1084-CUP1085-CUP1086-CUP1087-CUP1088-CUP1089-CUP1090-CUP1091-CUP1092-CUP1093-CUP1094-CUP1095-CUP1096-CUP1097-CUP1098-CUP1099-CUP1100-CUP1101-CUP1102-CUP1103-CUP1104-CUP1105-CUP1106-CUP1107-CUP1108-CUP1109-CUP1110-CUP1111-CUP1112-CUP1113-CUP1114-CUP1115-CUP1116-CUP1117-CUP1118-CUP1119-CUP1120-CUP1121-CUP1122-CUP1123-CUP1124-CUP1125-CUP1126-CUP1127-CUP1128-CUP1129-CUP1130-CUP1131-CUP1132-CUP1133-CUP1134-CUP1135-CUP1136-CUP1137-CUP1138-CUP1139-CUP1140-CUP1141-CUP1142-CUP1143-CUP1144-CUP1145-CUP1146-CUP1147-CUP1148-CUP1149-CUP1150-CUP1151-CUP1152-CUP1153-CUP1154-CUP1155-CUP1156-CUP1157-CUP1158-CUP1159-CUP1160-CUP1161-CUP1162-CUP1163-CUP1164-CUP1165-CUP1166-CUP1167-CUP1168-CUP1169-CUP1170-CUP1171-CUP1172-CUP1173-CUP1174-CUP1175-CUP1176-CUP1177-CUP1178-CUP1179-CUP1180-CUP1181-CUP1182-CUP1183-CUP1184-CUP1185-CUP1186-CUP1187-CUP1188-CUP1189-CUP1190-CUP1191-CUP1192-CUP1193-CUP1194-CUP1195-CUP1196-CUP1197-CUP1198-CUP1199-CUP1200-ONLINE001-ONLINE002-ONLINE003-ONLINE004-ONLINE005-ONLINE006-ONLINE007-ONLINE008-ONLINE009-ONLINE010-ONLINE011-ONLINE012-ONLINE013-ONLINE014-ONLINE015-ONLINE016-ONLINE017-ONLINE018-ONLINE019-ONLINE020-ONLINE021-ONLINE022-ONLINE023-ONLINE024-ONLINE025";
        
        NSLog(@"via if");
    }
    else
    {
        NSLog(@"via else");
    }
    
    enteredString = [defaults objectForKey:@"savedEntered10"];
    
    if ([enteredString length] == 0) {
        enteredString = @"0";
        
        NSLog(@"entered via if");
    }
    else
    {
        NSLog(@"entered via else");
    }
    
    entered = [enteredString intValue];
    
    NSLog(@"nihData abis if%@",nihData);
    
    dataGua = [nihData componentsSeparatedByString:@"-"];
    
    k = [dataGua count];
    
    for (int i=0; i<k; i++) {
        yoi = [dataGua objectAtIndex:i];
        
        if ([yoi isEqualToString:myNewString]) {
            [dataGua removeObjectAtIndex:i];
            
            hh = [dataGua componentsJoinedByString:@"-"];
            
            indicatorr.backgroundColor = [UIColor greenColor];
            
            entered += 1;
            
            countIn.text = [NSString stringWithFormat:@"People Entered: %d",entered];
            
            break;
        }
        else
        {
            hh = [dataGua componentsJoinedByString:@"-"];
            
            indicatorr.backgroundColor = [UIColor redColor];
            
            countIn.text = [NSString stringWithFormat:@"People Entered: %d",entered];
        }
    }
}

- (void)viewDidLoad
{
    [super viewDidLoad];
    
    _appDelegate = (AppDelegate *)[[UIApplication sharedApplication] delegate];
    
    [[NSNotificationCenter defaultCenter] addObserver:self
                                             selector:@selector(didReceiveDataWithNotification:)
                                                 name:@"MCDidReceiveDataNotification"
                                               object:nil];
    
	// Do any additional setup after loading the view, typically from a nib.
}

#pragma mark - Private method implementation

-(void)sendMyMessage{
    NSData *dataToSend = [myNewString dataUsingEncoding:NSUTF8StringEncoding];
    NSArray *allPeers = _appDelegate.mcManager.session.connectedPeers;
    NSError *error;
    
    [_appDelegate.mcManager.session sendData:dataToSend
                                     toPeers:allPeers
                                    withMode:MCSessionSendDataReliable
                                       error:&error];
    
    if (error) {
        NSLog(@"%@", [error localizedDescription]);
    }
    
    [_tvChat setText:[_tvChat.text stringByAppendingString:[NSString stringWithFormat:@"I wrote:\n%@\n\n", myNewString]]];
}

-(void)didReceiveDataWithNotification:(NSNotification *)notification{
    MCPeerID *peerID = [[notification userInfo] objectForKey:@"peerID"];
    NSString *peerDisplayName = peerID.displayName;
    
    NSData *receivedData = [[notification userInfo] objectForKey:@"data"];
    NSString *receivedText = [[NSString alloc] initWithData:receivedData encoding:NSUTF8StringEncoding];
    
    [_tvChat performSelectorOnMainThread:@selector(setText:) withObject:[_tvChat.text stringByAppendingString:[NSString stringWithFormat:@"%@ wrote:\n%@\n\n", peerDisplayName, receivedText]] waitUntilDone:NO];
    
    k = [dataGua count];
    
    for (int j=0; j<k; j++) {
        poi = [dataGua objectAtIndex:j];
        
        if ([poi isEqualToString:receivedText]) {
            [dataGua removeObjectAtIndex:j];
            
            hh = [dataGua componentsJoinedByString:@"-"];
            
            indicatorr.backgroundColor = [UIColor greenColor];
            
            break;
        }
        else
        {
            hh = [dataGua componentsJoinedByString:@"-"];
            
            indicatorr.backgroundColor = [UIColor redColor];
        }
    }
    
    NSLog(@"hh %@",hh);
    
    NSString *enjk = [NSString stringWithFormat:@"%d",entered];
    
    NSUserDefaults *defaults = [NSUserDefaults standardUserDefaults];
    [defaults setObject:hh forKey:@"savedString50"];
    [defaults setObject:enjk forKey:@"savedEntered10"];
    [defaults synchronize];
}

- (void)viewDidDisappear:(BOOL)animated{
    [super viewDidDisappear:YES];
    
    NSString *enzzz = [NSString stringWithFormat:@"%d",entered];
    
    NSLog(@"hh %@",hh);
    
    NSUserDefaults *defaults = [NSUserDefaults standardUserDefaults];
    [defaults setObject:hh forKey:@"savedString50"];
    [defaults setObject:enzzz forKey:@"savedEntered10"];
    [defaults synchronize];
}

- (void)didReceiveMemoryWarning
{
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

@end
